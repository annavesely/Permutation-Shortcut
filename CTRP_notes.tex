\documentclass[11pt,a4paper,openright,twoside]{article}
\usepackage[english]{babel}
\usepackage{newlfont}
\usepackage{color}
\textwidth=450pt\oddsidemargin=0pt
\usepackage{graphicx}
\usepackage{float}
\usepackage{textcomp}
\usepackage{caption}
\usepackage{wrapfig}
\usepackage{subfig}
\usepackage{sidecap}
\usepackage[rlft]{floatflt}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{bm}
\usepackage{fancyhdr}
\usepackage{multirow}
\usepackage[utf8x]{inputenc}
\usepackage{fullpage}
\usepackage[Lenny]{fncychap}
\usepackage[T1]{fontenc}
\usepackage[normalem]{ulem}
\usepackage{booktabs}
\usepackage{enumerate}
\usepackage{tikz}
\usepackage{pdflscape}
\usetikzlibrary{positioning}

\tikzset{c-rectangle1/.style={rectangle, rounded corners, minimum width=2cm, minimum height=1cm, text centered, text width=6cm, draw=black, fill=white},
arrow/.style={thick,->,>=stealth}}

\tikzset{c-rectangle2/.style={rectangle, rounded corners, minimum width=2cm, minimum height=1cm, text centered, text width=4cm, draw=black, fill=white},
arrow/.style={thick,->,>=stealth}}

%\usepackage[usenames,dvipsnames]{xcolor}
%\usepackage{listings}
%\usepackage{xcolor}

%\definecolor{light-gray}{gray}{0.95}
%\lstset{language=R,
%    basicstyle=\small\ttfamily,
%    stringstyle=\itshape\color{RedViolet},
%    showstringspaces=false,
%    otherkeywords={0,1,2,3,4,5,6,7,8,9},
%    morekeywords={TRUE,FALSE, ggplot, data.frame, theme, ylab, xlab},
%    deletekeywords={data, frame, beta, c, par, colours, contour, scale,
%                    panel, grid, hat},
%    keywordstyle=\color{RoyalBlue},
%    commentstyle=\itshape\color{PineGreen},
%    backgroundcolor=\color{light-gray}
%}

\title{Permutation Closed Testing with Sum-Based Statistics}
\author{}
\date{}





\begin{document}

\maketitle


\section{Sum-Based Test Statistics}
Given a full model $F=\{1,\ldots, f\}$ of univariate hypotheses, let $S\subseteq F$ be a subset under test by closed testing with level $\alpha$. Hence $S$ is rejected if and only if all its supersets $S\cup V$ ($V\subseteq F\setminus S$) are rejected.

Let
\[g_i^\pi\quad (i=1,\ldots,f,\; \pi=1,\ldots,B)\]
be some test statistics corresponding to the $f$ covariates and $B$ random permutations, where the first permutation is the identity. Assume that the null hypothesis is rejected for high values of $g_i$ (otherwise, it is sufficient to multiply all test statistics by $-1$), and
\[g_V^\pi=\sum_{i\in V}g_i^\pi\quad (V\subseteq F,\;\pi=1,\ldots,B).\]
Moreover, define the centered test statistics
\[d_i^\pi = g_i^\pi - g_i \quad (i=1,\ldots,f,\; \pi=1,\ldots,B),\]
so that the observed values are all $d_i=0$, and the variability due to $g_i$ is excluded.

For $V\subseteq F$, the vector of its statistics is
\[\mathbf{d_V}=(0,d_V^2,\ldots,d_V^B)^\top.\]
Consider the sorted test statistics $d_V^{(1)}\leq d_V^{(2)}\leq\ldots\leq d_V^{(B)}$, and define $k=\lceil (1-\alpha) B\rceil$. The permutation test rejects $V$ if
\[d_V^{(k)}< 0.\]
Such a test can be slightly conservative, but it can be adapted to be exact by randomizing it.







\vspace{10mm}

\section{Shortcut}
Let $s=|S|$ and $m=f-s$, and fix a value $v\in\{0,\ldots,m\}$. We will define a shortcut for the analysis of the supersets $S\cup V$ with $V\in\mathcal{V}_v$ and
\[\mathcal{V}_v=\{V\,:\,V\subseteq F\setminus S,\; |V|=v\},\]
that does not require all the $\binom{m}{v}$ vectors $\mathbf{d}_{V}$. It relies on the construction of a lower and an upper critical values, $L_v$ and $U_v$, such that
\begin{itemize}
\item if $L_v\geq 0$, then at least one superset $S\cup\tilde{V}$ is not rejected, and thus $S$ is not rejected;
\item if $U_v<0$, then all supersets are rejected, and other sizes can be explored.
\end{itemize}
Notice that if $L_v< 0\leq U_v$, then the outcome is indecisive. 


\paragraph{Lower critical value.} In order not to reject $S$, it is sufficient to find a non-rejected superset. We define the lower critical value as $L_v=(d_{S} + l_v)^{(k)}$, where $\mathbf{l}_v=\mathbf{d}_{\tilde{V}}$ and $\tilde{V}\in\mathcal{V}_v$ is such that $S\cup\tilde{V}$ is likely to be non-rejected.

In particular, $\tilde{V}$ is defined by considering the indices of the $v$ smallest observed statistics not in $S$. If $(i_1,\ldots,i_m)$ is a permutation of the indices in $F\setminus S$ such that
\[g_{i_1}\leq g_{i_2}\leq\ldots\leq g_{i_m},\]
then $\tilde{V}=\{i_1,\ldots,i_v\}$ and
\[l_v^\pi = \sum_{h=1}^v d_{i_h}^\pi\quad (\pi=1,\ldots,B).\]



\paragraph{Upper critical value.} The upper critical value is $U_v=(d_{S} + u_v)^{(k)}$, where
\[\mathbf{u}_v=(0,u_v^2,\ldots,u_v^B)^\top\]
is a vector such that
\[u_v^\pi\geq d_V^\pi\quad (V\in\mathcal{V}_v,\;\pi=1,\ldots,B).\]
As a consequence,
\[U_v \geq (d_S + d_V)^{(k)}\quad (V\in\mathcal{V}_v).\]
If $U_v<0$, then all supersets $S\cup V$ with $V\in\mathcal{V}_v$ are rejected.

For each $\pi=1,\ldots,B$, the element $u_v^\pi$ is defined by considering the $v$ highest centered statistics not in $S$. If $(j_1(\pi),\ldots,j_m(\pi))$ is a permutation of the indices in $F\setminus S$ such that
\[d_{j_1(\pi)}^\pi\geq d_{j_2(\pi)}^\pi\geq\ldots d_{j_m(\pi)}^\pi ,\]
then
\[u_v^\pi=\sum_{h=1}^v d_{j_h(\pi)}^\pi.\]




\paragraph{Testing.}
The values $v=0,\ldots, m$ are checked in sequence.
\begin{itemize}
\item As soon as a non-rejection is found (there exists $v^*$ such that $L_{v^*}\geq 0$), the analysis stops and $S$ is not rejected.
\item If all values lead to rejection ($U_v<0$ for all $v$), then $S$ is rejected.
\item If some values $v\in \{1,\ldots,m-1\}$ lead to indecisive outcomes ($L_v < 0\leq U_v$), the Branch and Bound method is applied. Notice that an indecisive outcome cannot occur for $v=0$ or $v=m$, since
\begin{align*}
& L_0=U_0=d_S^{(k)} & L_m=U_m=d_F^{(k)}.
\end{align*}
\end{itemize}



\paragraph{Early stop.} Assume that there exists $w\in\{1,\ldots,m\}$ such that all the elements of $\textbf{u}_w$ are smaller than those of $\textbf{u}_{w-1}$:
\[u_w^\pi =u_{w-1}^\pi +d_{j_w(\pi)}^\pi\leq u_{w-1}^\pi\quad (\pi=1,\ldots,B)\]
or, equivalently,
\[d_{j_w(\pi)}^\pi\leq 0\quad (\pi=1,\ldots,B).\]
Then the upper critical value is non-increasing for $v\geq w$:
\begin{align*}
d_{j_m(\pi)}^\pi\leq \ldots \leq d_{j_w(\pi)}^\pi \leq 0&\quad(\pi=1,\ldots,B)\\
u_m^\pi \leq\ldots\leq u_w^\pi\leq u_{w-1}^\pi&\quad(\pi=1,\ldots,B)\\
U_m \leq\ldots\leq U_w\leq U_{w-1}. &
\end{align*}

In this case, it is sufficient to stop the analysis as soon as we find a value $v^*\geq w-1$ such that $U_{v^*}<0$. All the supersets with $v\geq v^*$ are automatically rejected.





\vspace{10mm}

\section{Branch and Bound}
Assume that some values $v\in\{1,\ldots,m-1\}$ lead to an indecisive outcome. 

For a fixed index $e\in F\setminus S$, the total space $\mathbb{S}=\{V\,:\,V\subseteq F\setminus S\}$ is partitioned into two disjoint subspaces, according to the inclusion of $e$:
\begin{align*}
&\mathbb{S}_{-e}=\{V\,:\,V\subseteq F\setminus(S\cup\{e\})\} & \mathbb{S}_{+e}=\{V\,:\,\{e\}\subseteq V\subseteq F\setminus S\}.
\end{align*}

The shortcut is applied to each subspace, in order to evaluate the indecisive values $v$:
\begin{itemize}
\item if $S$ is not rejected in at least one subspace, it is not rejected in the total space;
\item if $S$ is rejected in both subspaces, it is rejected in the total space;
\item if there is an indecisive outcome in at least one subspace, the procedure is iterated by partitioning the indecisive subspace(s).
\end{itemize}

For any choice of $e$, $U_v$ does not increase in the subspaces (since it is defined by taking the maximum statistics over smaller subsets). However, the choice of $e$ and the order in which the subspaces are explored influence $L_v$, and thus the efficiency of the algorithm. We wish to begin with the subspaces that are more likely to lead to a non-rejection, i.e. where $L_v$ is more likely to be high.

We will evaluate the efficiency in four different scenarios, employing the order of the observed statistics in $F\setminus S$. The scenarios differ by the index $e$ used for branching:
\begin{itemize}
\item highest statistic $e=i_m$ ($L_v$ does not vary in $\mathbb{S}_{-e}$);
\item lowest statistic $e=i_1$ ($L_v$ does not vary in $\mathbb{S}_{+e}$).
\end{itemize}
Moreover, they differ by the branch that is explored first:
\begin{itemize}
\item $\mathbb{S}_{-e}$, removal;
\item $\mathbb{S}_{+e}$, keeping.
\end{itemize}
Preliminary simulations suggest that removing the highest statistic could lead to the smallest number of iterations in most cases.









\newpage

\section{Example}
Considering $f=5$ predictors and $B=10$ permutations, we simulate a $B\times f$ matrix of global test statistics:

\begin{table}[h!]
\centering
\begin{tabular}{ccccc}
\multicolumn{5}{c}{$\mathbf{G}$}\\
$(1)$ & $(2)$ & $(3)$ & $(4)$ & $(5)$\\
\cline{1-5}
28.42 & 16.68 & 9.36 & 6.12 & 9.40\\
0.10 & 0.06 & 1.37 & 0.08 & 0.56\\
0.69 & 3.07 & 4.33 & 0.83 & 0.36\\
1.07 & 30.31 & 1.11 & 8.55 & 0.26\\
0.22 & 7.45 & 2.87 & 0.48 & 1.02\\
1.83 & 0.04 & 2.85 & 0.04 & 0.02\\
17.68 & 1.82 & 6.00 & 1.52 & 1.06\\
1.77 & 26.12 & 0.29 & 0.26 & 4.07\\
2.71 & 0.37 & 8.47 & 5.83 & 4.42\\
1.14 & 0.03 & 24.06 & 8.84 & 2.41\\
\end{tabular}
\end{table}

Assume that we want to test $S=\{5\}$ with significance level $\alpha=0.20$.




\paragraph{Shortcut.}
\begin{table}[h!]
\centering
\resizebox{\textwidth}{!}{
\begin{tabular}{c|ccccccccccc}
v &   &  &  &  &  &  &  &  &  &  &  \\
4 &  &  &  &  &  & $\mathbf{F=\{1,2,3,4,5\}}$ &  &  &  &  &  \\
3 &  &  & $\{1,2,3,5\}$ &  & $\{1,2,4,5\}$ &  & $\{1,3,4,5\}$ &  & $\mathbf{\{2,3,4,5\}}$ &  &  \\
2 & $\{1,2,5\}$  &  & $\{1,3,5\}$ &  & $\{1,4,5\}$ &  & $\{2,3,5\}$ &  & $\{2,4,5\}$ &  & $\mathbf{\{3,4,5\}}$ \\
1 &  &  & $\{1,5\}$ &  & $\{2,5\}$ &  & $\{3,5\}$ &  & $\mathbf{\{4,5\}}$ &  &  \\
0 &  &  &  &  &  & $\mathbf{S=\{5\}}$ &  &  &  &  &  
\end{tabular}
}
\caption{Supersets of $S=\{5\}$by size. The sets in bold are used to define the lower critical value $L_v$.}
\end{table}

We define
\begin{itemize}
\item $\mathbf{D}$, matrix of the centered test statistics in $F\setminus S$, where the indices appear in the order $(4,3,2,1)$ (since $g_4\leq g_3\leq g_2\leq g_1$);
\item $\mathbf{R}$, matrix obtained from $\mathbf{D}$ by sorting the elements within each row in decreasing order;
\item $\mathbf{Dsum}$ and $\mathbf{Rsum}$, matrices of the cumulative sums of $\mathbf{d}_S$ with $\mathbf{D}$ and $\mathbf{R}$, respectively.
\end{itemize}

Let $k=\lceil (1-\alpha) B\rceil =8$. The lower and upper critical values, $L_v$ and $U_v$, are the $k$-th ordered statistics of
\begin{align*}
& \mathbf{d}_S +\mathbf{l}_{v}=\mathbf{Dsum}_{v+1} & \mathbf{d}_S + \mathbf{u}_v=\mathbf{Rsum}_{v+1}.
\end{align*}

The first column of $\mathbf{R}$ having no positive elements has index $w=3$. We start by computing both bounds for $v=0,1,2$. No non-rejection is found, but the values $v=1,2$ lead to an indecisive outcome.

We proceed by examining $v\leq 3$, until we find either a rejection or a negative $U_v$. Since $U_v$ becomes negative for $v=3$, the supersets with $v=3,4$ are automatically rejected.


\newpage

\begin{table}[h!]
\centering
%\resizebox{\textwidth}{!}{
\begin{tabular}{ccccccccccc}
$\mathbf{d}_S$ & & \multicolumn{4}{c}{$\mathbf{D}$} & & \multicolumn{4}{c}{$\mathbf{R}$}\\
$(5)$ &  & $(4)$ & $(3)$ & $(2)$ & $(1)$ &  &  &  &  &  \\
\cline{1-1} \cline{3-6} \cline{8-11}
0.00 &  & 0.00 & 0.00 & 0.00 & 0.00 &  & 0.00 (1)& 0.00 (2)& 0.00 (3)& 0.00 (4)\\
-8.84 &  & -6.03 & -7.99 & -16.62 & -28.32 &  & -6.03 (4)& -7.99 (3)& -16.62 (2)& -28.32 (1)\\
-9.04 &  & -5.29 & -5.02 & -13.61 & -27.72 &  & -5.02 (3)& -5.29 (4)& -13.61 (2)& -27.72 (1)\\
-9.14 &  & 2.43 & -8.25 & 13.63 & -27.34 &  & 13.63 (2)& 2.43 (4)& -8.25 (3)& -27.34 (1)\\
-8.38 &  & -5.63 & -6.49 & -9.23 & -28.19 &  & -5.63 (4)& -6.49 (3)& -9.23 (2)& -28.19 (1)\\
-9.38 &  & -6.08 & -6.51 & -16.64 & -26.59 &  & -6.08 (4)& -6.51 (3)& -16.64 (2)& -26.59 (1)\\
-8.34 &  & -4.59 & -3.36 & -14.86 & -10.74 &  & -3.36 (3)& -4.59 (4)& -10.74 (1)& -14.86 (2)\\
-5.33 &  & -5.85 & -9.07 & 9.44 & -26.65 &  & 9.44 (2)& -5.85 (4)& -9.07 (3)& -26.65 (1)\\
-4.98 &  & -0.28 & -0.89 & -16.31 & -25.71 &  & -0.28 (4)& -0.89 (3)& -16.31 (2)& -25.71 (1)\\
-6.99 &  & 2.72 & 14.70 & -16.65 & -27.27 &  & 14.70 (3)& 2.72 (4)& -16.65 (2) & -27.27 (1)
\end{tabular}
%}
\end{table}

\begin{table}[h!]
\centering
%\resizebox{\textwidth}{!}{
\begin{tabular}{ccccccccccc}
\multicolumn{5}{c}{$\mathbf{Dsum}$} & & \multicolumn{5}{c}{$\mathbf{Rsum}$}\\
\cline{1-5} \cline{7-11}
0.00 & 0.00 & 0.00 & 0.00 & 0.00 &  & 0.00 & 0.00 & 0.00 & 0.00 & 0.00\\
-8.84 & -14.87 &-22.86 &-39.48 & -67.80 &  & -8.84 & -14.87 & -22.86 & -39.48 & -67.80\\
-9.04 & -14.33 & -19.35 & -32.97 & -60.69 &  & -9.04 & -14.07 & -19.35 & -32.97 & -60.69\\
-9.14 & -6.71 & -14.97 & -1.33 & -28.68 &  & -9.14 & 4.49 & 6.92 & -1.33 & -28.68\\
-8.38 & -14.02 & -20.51 & -29.74 & -57.94 &  & -8.38 & -14.02 & -20.51 & -29.74 & -57.94\\
-9.38 & -15.46 & -21.96 & -38.61 & -65.20 &  & -9.38 & -15.46 & -21.96 & -38.61 & -65.20\\
-8.34 & -12.93 & -16.29 & -31.15 & -41.89 &  & -8.34 & -11.69 & -16.29 & -27.03 & -41.89\\
-5.33 & -11.18 & -20.26 & -10.81 & -37.46 &  & -5.33 & 4.11 & -1.74 & -10.81 & -37.46\\
-4.98 & -5.26 & -6.16 & -22.47 & -48.18 &  & -4.98 & -5.26 & -6.16 & -22.47 & -48.18\\
-6.99 & -4.27 & 10.43 & -6.22 & -33.49 &  & -6.99 & 7.71 & 10.43 & -6.22 &-33.49
\end{tabular}
%}
\end{table}

\vspace{2mm}

\begin{figure}[h!]
\centering
\includegraphics[scale=0.5]{example1.pdf}
\caption{Upper (red) and lower (blue) critical values by additional superset size $v$. The bounds for $v=4$ have not been computed in the analysis.}
%\label{fig:bounds}
\end{figure}


\begin{table}[h!]
\centering
\begin{tabular}{cccccc}
\toprule
$v$ & 0 & 1 & 2 & 3 & 4\\
\midrule
$U_v$ & -5.33 & 4.11 & 0.00 & -6.22 & (-33.49)\\
$L_v$ & -5.33 & -5.26 & -6.16 & -6.22 & (-33.49)\\
\midrule
rej & T & ? & ? & T & T\\
\bottomrule
\end{tabular}
\end{table}

\newpage

\paragraph{Branch and Bound (removal of the highest statistic).} The index of the highest test statistic, $e=1$, determines the branching rule. We start by studying $U_v$ for the indecisive sizes in the subspace $\mathbb{S}_{-1}$ (since $L_v$ does not vary). As shown in figure \ref{fig:bab}, the outcome is still indecisive for both sizes $v=1,2$.

Then we remove the second highest statistic ($e=2$). In $\mathbb{S}_{-1,-2}$, where we examine only $U_v$, the null hypothesis is rejected.

Finally, we analyze both bounds in $\mathbb{S}_{-1,+2}$, where a non-rejection is found for $v=0$. In conclusion, the null hypothesis is not rejected after 3 steps.

\vspace{5mm}

\begin{figure}[h!]
\centering
\begin{tikzpicture}[node distance = 4cm]
\node (n0) [c-rectangle1] {Start\\
\resizebox{6cm}{!}{
\begin{tabular}{cccccc}
\toprule
$v$ & 0 & 1 & 2 & 3 & 4\\
\midrule
$U_v$ & (-5.33) & 4.11 & 0.00 & -6.22 & -33.49\\
$L_v$ & -5.33 & -5.26 & -6.16 & -6.22 & -33.49\\
\midrule
rej & T & ? & ? & T & T\\
\bottomrule
\end{tabular}
}
};
\node (n1) [c-rectangle2, below of=n0, xshift=-4cm] {Step 1\\
\begin{tabular}{ccc}
\toprule
$v$ & 1 & 2 \\
\midrule
$U_v$ & 4.11 & 0.00\\
$L_v$ & (-5.26) & (-6.16)\\
\midrule
rej & ? & ?\\
\bottomrule
\end{tabular}
};
\node (n2) [c-rectangle2, below of=n1, xshift=-3cm] {Step 2\\
\begin{tabular}{ccc}
\toprule
$v$ & 1 & 2 \\
\midrule
$U_v$ & -5.26 & -6.16\\
$L_v$ & (-5.26) & (-6.16)\\
\midrule
rej & T & T\\
\bottomrule
\end{tabular}
};
\node (n3) [c-rectangle2, below of=n1, xshift=3cm] {Step 3\\
\begin{tabular}{ccc}
\toprule
$v$ & 0 & 1 \\
\midrule
$U_v$ & (0.00) & -1.74\\
$L_v$ & 0.00 & -1.74\\
\midrule
rej & F & T\\
\bottomrule
\end{tabular}
};
\draw [arrow] (n0) -- node[anchor=east] {-(1)} (n1);
\draw [arrow] (n1) -- node[anchor=east] {-(2)} (n2);
\draw [arrow] (n1) -- node[anchor=west] {+(2)} (n3);
\end{tikzpicture}
\caption{Branch and Bound procedure, carried out by removing the highest test statistic.}
\label{fig:bab}
\end{figure}





\newpage
\section{True Discovery Proportion}

Assume that $S$ is rejected by closed testing. The true discoveries can be estimated by analysing the subsets
\[\mathcal{Z}_z=\{Z\subseteq S\,:\, |Z|=s-z\}\]
for $z=0,\ldots,s-1$. Indeed, if all elements of $\mathcal{Z}_z$ are rejected by closed testing, then $TD \geq z+1$. The highest bound corresponds to the maximum $z$ value such that the condition is true.

$\mathcal{Z}_0=\{S\}$ has already been rejected. The supersets of $Z\in\mathcal{Z}_1$ are
\begin{itemize}
\item $S$ and its supersets (already rejected by the local tests);
\item supersets with the form $Z\cup V$, with $V\subseteq F\setminus S$.
\end{itemize}

Analogously, consider $\mathcal{Z}_z$, after rejecting all the elements of $\mathcal{Z}_0,\ldots,\mathcal{Z}_{z-1}$. In order to reject $Z\in\mathcal{Z}_z$, the only supersets that need to be studied have the form $Z\cup V$, with $V\subseteq F\setminus S$. We will define bounds $L_{z,v}$ and $U_{z,v}$ for the critical values of such sets.



\paragraph{Lower critical value.}  Let $\mathbf{l}_{0,v}=\mathbf{l}_v$ as defined in section 2. Let $(x_1,\ldots,x_s)$ be a permutation of the indices in $S$ such that
\[ g_{x_1}\leq g_{x_2}\leq\ldots\leq g_{x_s}.\]
For $z=1,\ldots,s$, the lower critical value is $L_{z,v}=(d_S + l_{z,v})^{(k)}$, where
\[l_{z,v}^\pi = l_{z-1,v}^\pi - d_{x_{s-z+1}}^\pi .\]
Notice that
\[d_S^\pi + l_{z,v}^\pi = \sum_{h=1}^z d_{x_h}^\pi + \sum_{h=1}^v d_{i_h}^\pi \]
is the test statistic corresponding to the set $\tilde{Z}\cup\tilde{V}=\{x_1,\ldots,x_z\}\cup\{i_1,\ldots,i_v\}$, likely to be rejected.


\paragraph{Upper critical value.} Let $\mathbf{u}_{0,v}=\mathbf{u}_v$ as defined in section 2. For each $\pi=1,\ldots,B$, let $(y_1(\pi),\ldots,y_s(\pi))$ be a permutation of the indices in $S$ such that
\[ d_{y_1(\pi)}^\pi\geq d_{y_2(\pi)}^\pi\geq\ldots d_{y_s(\pi)}^\pi .\]
Then $U_{z,v}=(d_{S} + u_{z,v})^{(k)}$ with
\[u_{z,v}^\pi = u_{z-1,v}^\pi - d_{y_{s-z+1}(\pi)}^\pi .\]
Notice that
\[d_{S}^\pi + u_{z,v}^\pi = \sum_{h=1}^z d_{y_h(\pi)}^\pi + \sum_{h=1}^v d_{j_h(\pi)}^\pi .\]






\newpage
\section{Example 2}
Considering $f=7$ predictors and $B=10$ permutations, we simulate a $B\times f$ matrix of global test statistics:

\begin{table}[h!]
\centering
\begin{tabular}{ccccccc}
\multicolumn{7}{c}{$\mathbf{G}$}\\
$(1)$ & $(2)$ & $(3)$ & $(4)$ & $(5)$ & $(6)$ & $(7)$\\
\cline{1-7}
9.45 & 8.26 & 7.91 & 0.76 & 35.34 & 16.42 & 13.72\\
5.86 & 0.57 & 0.37 & 29.85 & 0.98 & 0.44 & 0.00\\
0.02 & 2.03 & 3.33 & 1.42 & 0.00 & 2.40 & 0.15\\
4.07 & 33.21 & 1.24 & 0.28 & 0.41 & 7.93 & 3.97\\
0.52 & 24.95 & 13.23 & 0.06 & 1.48 & 0.96 & 2.81\\
0.28 & 0.34 & 0.56 & 0.25 & 11.41 & 3.19 & 5.41\\
5.55 & 2.79 & 1.01 & 6.44 & 3.71 & 1.73 & 2.07\\
0.14 & 5.84 & 4.76 & 1.12 & 0.92 & 0.10 & 0.09\\
22.72 & 10.99 & 7.75 & 18.32 & 18.87 & 0.09 & 0.06\\
7.92 & 0.49 & 3.18 & 3.05 & 20.55 & 14.36 & 4.97\\
\end{tabular}
\end{table}

After rejecting $S=\{5,6,7\}$ with significance level $\alpha=0.20$, we want to estimate the TDP. We examine the subsets of size $s-z$, with $z=1,2$.

We define
\begin{itemize}
\item $\mathbf{Ds}$ and $\mathbf{D}$, matrices of the centered test statistics in $S$ and $F\setminus S$, respectively;
\item $\mathbf{Rs}$ and $\mathbf{R}$, matrices obtained from $\mathbf{Ds}$ and $\mathbf{D}$ by sorting the elements within each row in decreasing order;
\item $\mathbf{Dsum}$ and $\mathbf{Rsum}$, matrices of the cumulative sums of $\mathbf{d}_S$ with $\mathbf{D}$ and $\mathbf{R}$, respectively.
\end{itemize}

Let $k=\lceil (1-\alpha) B\rceil =8$. The lower and upper critical values $L_{z,v}$ and $U_{z,v}$ are the $k$-th ordered statistics of $\mathbf{Dsum(z)}_{v+1}$ and $\mathbf{Rsum(z)}_{v+1}$, where
\begin{align*}
& \mathbf{Dsum(1)}=\mathbf{Dsum} - \mathbf{Ds}_{s} & \mathbf{Rsum(1)}=\mathbf{Rsum} - \mathbf{Rs}_{s}\\
& \mathbf{Dsum(2)}=\mathbf{Dsum(1)} - \mathbf{Ds}_{s-1} & \mathbf{Rsum(2)}=\mathbf{Rsum(1)} - \mathbf{Rs}_{s-1}
\end{align*}

The first column of $\mathbf{R}$ having no positive elements has index $w=4$. Hence we compute both bounds for $v<4$ and we examine $v=2$ only if $U_{z,3}\geq 0$.
\begin{itemize}
\item $z=1$: no non-rejection, but values $v=2,3$ lead to an indecisive outcome. The Branch and Bound method is needed.
\item $z=2$: a non-rejection is found for $v=1$, hence not all subsets of size $s-2$ can be rejected.
\end{itemize}
In conclusion, the true discoveries are $1\leq TD\leq 2$.



\newpage
\begin{table}[h!]
\centering
%\resizebox{\textwidth}{!}{
\begin{tabular}{cccccccc}
\multicolumn{3}{c}{$\mathbf{Ds}$} & & \multicolumn{4}{c}{$\mathbf{D}$}\\
$(7)$ & $(6)$ & $(5)$ & & $(4)$ & $(3)$ & (2) & (1) \\
\cline{1-3} \cline{5-8}
0.00 & 0.00 & 0.00 &  & 0.00 & 0.00 & 0.00 & 0.00 \\
-13.72 & -15.98 & -34.36 & & 29.08 & -7.54 & -7.68 & -3.58\\
-13.58 & -14.02 & -35.34 & & 0.65 & -4.58 & -6.23 & -9.42\\
-9.75 & -8.49 & -34.93 & & -0.49 & -6.67 & 24.95 & -5.37\\
-10.91 & -15.47 & -33.86 & & -0.70 & 5.32 & 16.69 & -8.92\\
-8.32 & -13.23 & -23.92 & & -0.52 & -7.34 & -7.92 & -9.16\\
-11.66 & -14.69 & -31.62 & & 5.68 & -6.89 & -5.47 & -3.89\\
-13.64 & -16.33 & -34.42 & & 0.35 & -3.14 & -2.41 & -9.30\\
-13.66 & -16.33 & -16.46 & & 17.56 & -0.16 & 2.73 & 13.27\\
-8.75 & -2.06 & -14.79 & & 2.29 & -4.73 & -7.77 & -1.53
\end{tabular}
%}
\end{table}



\begin{table}[h!]
\centering
%\resizebox{\textwidth}{!}{
\begin{tabular}{cccccccc}
\multicolumn{3}{c}{$\mathbf{Rs}$} & & \multicolumn{4}{c}{$\mathbf{R}$}\\
\cline{1-3} \cline{5-8}
0.00 (5) & 0.00 (6) & 0.00 (7) &  & 0.00 (1) & 0.00 (2) & 0.00 (3) & 0.00 (4)\\
-13.72 (7) & -15.98 (6) & -34.36 (5) & & 29.08 (4) & -3.58 (1) & -7.54 (3) & -7.68 (2)\\
-13.58 (7) & -14.02 (6) & -35.34 (5) & & 0.65 (4) & -4.58 (3) & -6.23 (2) & -9.42 (1)\\
-8.49 (6) & -9.75 (7) & -34.93 (5) & & 24.95 (2) & -0.49 (4) & -5.37 (1) & -6.67 (3) \\
-10.91 (7) & -15.47 (6) & -33.86 (5) & & 16.69 (2) & 5.32 (3) & -0.70 (4) & -8.92 (1)\\
-8.32 (7) & -13.23 (6) & -23.92 (5) & & -0.52 (4) & -7.34 (3) & -7.92 (2) & -9.16 (1)\\
-11.66 (7) & -14.69 (6) & -31.62 (5) & & 5.68 (4) & -3.89 (1) & -5.47 (2) & -6.89 (3)\\
-13.64 (7) & -16.33 (6) & -34.42 (5) & & 0.35 (4) & -2.41 (2) & -3.14 (3) & -9.30 (1)\\
-13.66 (7) & -16.33 (6) & -16.46 (5) & & 17.56 (4) & 13.27 (1) & 2.73 (2) & -0.16 (3)\\
-2.06 (6) & -8.75 (7) & -14.79 (5) & & 2.29 (4) & -1.53 (1) & -4.73 (3) & -7.77 (2)
\end{tabular}
%}
\end{table}

\begin{table}[h!]
\centering
%\resizebox{\textwidth}{!}{
\begin{tabular}{ccccccccccc}
\multicolumn{5}{c}{$\mathbf{Dsum}$} & & \multicolumn{5}{c}{$\mathbf{Rsum}$}\\
\cline{1-5} \cline{7-11}
0.00 & 0.00 & 0.00 & 0.00 & 0.00 &  & 0.00 & 0.00 & 0.00 & 0.00 & 0.00\\
-64.06 & -34.97 & -42.51 & -50.20 & -53.78 & & -64.06 & -34.97 & -38.56 & -46.10 & -53.78\\
-62.93 & -62.28 & -66.86 & -73.09 & -82.51 & & -62.93 & -62.28 & -66.86 & -73.09 & -82.51\\
-53.17 & -53.66 & -60.33 & -35.37 & -40.75 & & -53.17 & -28.22 & -28.71 & -34.08 & -40.75\\
-60.24 & -60.93 & -55.62 & -38.92 & -47.84 & & -60.24 & -43.54 & -38.22 & -38.92 & -47.84\\
-45.47 & -45.99 & -53.33 & -61.25 & -70.41 & & -45.47 & -45.99 & -53.33 & -61.25 & -70.41\\
-57.97 & -52.29 & -59.18 & -64.65 & -68.54 & & -57.97 & -52.29 & -56.18 & -61.65 & -68.54\\
-64.39 & -64.03 & -67.18 & -69.59 & -78.89 & & -64.39 & -64.03 & -66.44 & -69.59 & -78.89\\
-46.45 & -28.90 & -29.05 & -26.32 & -13.05 & & -46.45 & -28.90 & -15.63 & -12.90 & -13.05\\
-25.60 & -23.32 & -28.05 & -35.82 & -37.35 & & -25.60 & -23.32 & -24.85 & -29.58 & -37.35
\end{tabular}
%}
\end{table}



\newpage
\begin{figure}
\centering
\subfloat[$z=0$]{\includegraphics[width= 7.5cm]{example2_0.pdf}}\\
\subfloat[$z=1$]{\includegraphics[width= 7.5cm]{example2_1.pdf}}\quad \subfloat[$z=2$]{\includegraphics[width= 7.5cm]{example2_2.pdf}}
\caption{Upper (red) and lower (blue) critical values by additional superset size $v$ for the subsets of size $s-z$.}
\end{figure}

\vspace{3mm}

\paragraph{Branch and Bound (removal of the highest statistic not in $S$).} The method is applied to examine $z=1$ and $v=2,3$. The index of the highest test statistic, $e=1$, determines the branching rule. We start by studying the subspace $\mathbb{S}_{-1}$.

As shown in figure \ref{fig:bab2}, after 4 steps the subsets of size $s-1$ are not rejected. Hence the true discoveries are $TD=1$.


\newpage
\begin{figure}[h!]
\centering
\begin{tikzpicture}[node distance = 4cm]
\node (n0) [c-rectangle1] {Start\\
\resizebox{6cm}{!}{
\begin{tabular}{cccccc}
\toprule
$v$ & 0 & 1 & 2 & 3 & 4\\
\midrule
$U_v$ & (-18.24) & -0.62 & 0.00 & 0.00 & -5.82\\
$L_v$ & -18.24 & -8.53 & -12.59 & -5.07 & -5.82\\
\midrule
rej & T & T & ? & ? & T\\
\bottomrule
\end{tabular}
}
};
\node (n1) [c-rectangle2, below of=n0, xshift=-4cm] {Step 1\\
\begin{tabular}{ccc}
\toprule
$v$ & 2 & 3 \\
\midrule
$U_v$ & 4.37 & -5.07\\
$L_v$ & (-12.59) & (-5.07)\\
\midrule
rej & T & T\\
\bottomrule
\end{tabular}
};
\node (n2) [c-rectangle2, below of=n0, xshift=4cm] {Step 2\\
\begin{tabular}{ccc}
\toprule
$v$ & 1 & 2 \\
\midrule
$U_v$ & 0.00 & 0.00\\
$L_v$ & -4.20 & -11.74\\
\midrule
rej & ? & ?\\
\bottomrule
\end{tabular}
};
\node (n3) [c-rectangle2, below of=n2, xshift=-3cm] {Step 3\\
\begin{tabular}{ccc}
\toprule
$v$ & 1 & 2 \\
\midrule
$U_v$ & (-4.20) & -11.74\\
$L_v$ & (-4.20) & (-11.74)\\
\midrule
rej & T & T\\
\bottomrule
\end{tabular}
};
\node (n4) [c-rectangle2, below of=n2, xshift=3cm] {Step 4\\
\begin{tabular}{ccc}
\toprule
$v$ & 0 & 1 \\
\midrule
$U_v$ & (-13.99) & 0.00\\
$L_v$ & -13.99 & 0.00\\
\midrule
rej & T & F\\
\bottomrule
\end{tabular}
};
\draw [arrow] (n0) -- node[anchor=east] {-(1)} (n1);
\draw [arrow] (n0) -- node[anchor=west] {+(1)} (n2);
\draw [arrow] (n2) -- node[anchor=east] {-(2)} (n3);
\draw [arrow] (n2) -- node[anchor=west] {+(2)} (n4);
\end{tikzpicture}
\caption{Branch and Bound procedure for the subsets of size $s-1$, carried out by removing the highest test statistic not in $S$.}
\label{fig:bab2}
\end{figure}




\end{document}